<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Comment me recycler ?</title>
    <script src="//code.jquery.com/jquery-2.2.1.min.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/static/js/JOB.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"
          integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <style>
        html {
            position: relative;
            min-height: 100%;
        }

        body {
            /* Margin bottom by footer height */
            margin-bottom: 60px;
        }

        .footer {
            position: absolute;
            bottom: 10px;
            width: 100%;
        }

        .form-control-inline {
            min-width: 0;
            width: auto;
            display: inline;
        }

        .suggest-checkbox {
            margin-top: 0px;
            margin-bottom: 5px;
        }

        .bin {
            float: none;
        }

        #image {
            max-width: 300px;
        }

        #loading {
            opacity: 0;
        }

        .glyphicon.spinning {
            animation: spin 1.5s infinite linear;
            -webkit-animation: spin2 1.5s infinite linear;
        }

        @keyframes spin {
            from { transform: scale(1) rotate(0deg); }
            to { transform: scale(1) rotate(360deg); }
        }

        @-webkit-keyframes spin2 {
            from { -webkit-transform: rotate(0deg); }
            to { -webkit-transform: rotate(360deg); }
        }

        #barcode_file_input {
            width: 200px;
        }
    </style>
</head>
<body>
<section class="container-fluid text-center">
    <header class="page-header"><h1>Comment me recycler ?</h1>à Paris</header>
    <p>
        Vous ne savez pas dans quelle poubelle jeter les différents emballages d'un produit ?<br>
        Ne cherchez plus, choisissez une photo avec le code barre ou rentrez le ci-dessous !
    </p>
    <div class="row">
        <form role="form" class="form-inline" id="recycle_form">
            <label class="sr-only" for="barcode">Code barre</label>
            <input class="form-control form-control-inline" id="barcode_file_input" type="file" accept="image/*;capture=camera" />
            <input type="text" class="form-control form-control-inline" id="barcode" placeholder="Code barre" size="24" required>
            <button type="submit" class="btn btn-primary">
                Recycler
            </button>
            <span style="width:40px">&nbsp;
                <span class="glyphicon glyphicon-refresh spinning" id="loading"></span>
            </span>
            <span class="help-block" id="help"></span>
        </form>
    </div>
</section>

<section class="container-fluid collapse text-center" id="product">
    <h2 class="name"></h2>
    <div class="row">
        <div class="col-sm-4 col-sm-offset-2">
            <img src="" id="image">
            <div class="source">Source: <a href="" id="source_url" target="_blank"></a></div>
            <button type="button" class="btn btn-warning" data-toggle="modal" data-target="#blacklist_modal">Pas le bon produit ?</button>
        </div>
        <div class="col-sm-4">
            <div class="collapse text-center" id="no_data">
                <h3>Aucune information d'emballage trouvée</h3>
                <button type="button" class="btn btn-warning suggest_button" data-toggle="modal" data-target="#suggest_modal">Suggérer un emballage</button>
            </div>

            <div class="text-center collapse" id="throwaway">
                <div id="bins"></div>
                <div class="text-center">
                    <button type="button" class="btn btn-default suggest_button" data-toggle="modal" data-target="#suggest_modal">Modifier un emballage</button>
                </div>
            </div>
        </div>
    </div>
</section>


<!-- Blacklist Modal -->
<div class="modal fade" id="blacklist_modal" role="dialog">
    <div class="modal-dialog">

        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h2 class="modal-title">Signaler un mauvais produit</h2>
            </div>
            <div class="modal-body">
                <p>Le code barre <b class="ean"></b> ne correspond pas à <b class="name "></b> ?</p>
                <form role="form" class="form-inline" id="blacklist_form">
                    <label class="sr-only" for="blacklist_name">Nom du bon produit</label>
                    <input type="text" class="form-control form-control-inline" id="blacklist_name" placeholder="Nom du bon produit" size="50" required>
                    <button type="submit" class="btn btn-primary">
                        Signaler
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Suggest Modal -->
<div class="modal fade" id="suggest_modal" role="dialog">
    <div class="modal-dialog">

        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h2 class="modal-title">Suggérer ou modifier un emballage</h2>
            </div>
            <div class="modal-body">
                <div id="suggest_help"></div>
                <form role="form" class="form-group" id="suggest_form">
                    <div id="materials_list" class="row text-left">
                    </div>
                    <button type="submit" class="btn btn-primary">
                        Suggérer
                    </button>
                </form>
                <!--<form role="form" class="form-inline" id="missing_package_form">-->
                    <!--<label class="sr-only" for="missing_package_name">Nom d'un emballage</label>-->
                    <!--<input type="text" class="form-control form-control-inline" id="missing_package_name" placeholder="Nom d'un emballage" size="50" required>-->
                    <!--<button type="submit" class="btn btn-default">-->
                        <!--Ajouter-->
                    <!--</button>-->
                <!--</form>-->
            </div>
        </div>
    </div>
</div>

<footer class="footer">
    <div class="container text-center small">
        2016 // <a href="mailto:jfyuen@gmail.com">jfyuen</a> //
        <a href="https://github.com/jfyuen/recycleme" target="_blank">source</a>
    </div>
</footer>
<script>
"use strict";

$(function() {

    JOB.Init();
    JOB.SetImageCallback(function(result) {
        if(result.length == 1) {
            var ean = result[0].Value;
            $("#barcode").val(ean); // Only take 1st bar code
            App.isLoading = false; // hack to prevent loading disappearing
            App.submit(ean);
        } else {
            App.stopLoading();
            $("#recycle_form").addClass("has-error");
            if(result.length == 0) {
                $("#help").text("No bar code found");
            } else {
                $("#help").text("Multiple bar codes found");
            }
        }
    });

    JOB.SetErrorCallback(function() {
        App.stopLoading();
        $("#recycle_form").addClass("has-error");
        $("#help").text("cannot read image");
    });

    var App = {
        init: function(job) {
            this.attachListeners();
            this.product = null;
            this.job = job;
            this.isLoading = false;
        },

        attachListeners: function() {
            var self = this;

            $("#barcode_file_input").on("change", function(e){
                $("#help").empty();
                $("#recycle_form").removeClass("has-error");
                $("#barcode").val("");
                var input = $("#barcode_file_input");
                if (input[0].files && input[0].files.length) {
                    var tmpImgURL = URL.createObjectURL(input[0].files[0]);
                    self.startLoading();
                    self.job.DecodeImage(tmpImgURL);
                }
            });


            $("#recycle_form").submit(function (evt) {
                evt.preventDefault();

                var barcode = $("#barcode");
                var barcodeVal = barcode.val();
                return self.submit(barcodeVal);
            });
        },
        detachListeners: function() {
            $("#recycle_form").off("submit");
        },

        reset: function() {
            $("#no_data").hide();
            $("#product").hide();
            $(".name").empty();
            $(".ean").empty();
            $("#image").src = "";
            $("#throwaway").hide();
            $("#bins").empty()
            $("#source_url").empty();
        },

        startLoading: function() {
            this.isLoading = true;
            $("#loading").fadeTo("fast", 1.);
        },

        stopLoading: function() {
            this.isLoading = false;
            $("#loading").fadeTo("fast", 0.);
        },

        submit: function(ean) {
            var self = this;

            if (self.isLoading) {
                return false;
            }

            self.reset();

            var recycle = $("#recycle_form");
            if (ean.length == 0) {
                recycle.addClass("has-error");
            } else {
                self.product = null;
                self.startLoading();
                recycle.removeClass("has-error");
                $("#help").empty();
                var url = "/throwaway/" + ean;

                $.get(url, function(data) {
                    data = $.parseJSON(data)
                    var throwAway = data.throwAway;
                    self.product = data.product;
                    $(".name").text(self.product.name);
                    $(".ean").text(self.product.ean);
                    $("#image").attr("src", self.product.imageURL);
                    var sourceUrl = $("#source_url");
                    sourceUrl.attr("href", self.product.websiteURL);
                    sourceUrl.text(self.product.websiteName);
                    $("#product").show();

                    if (jQuery.isEmptyObject(throwAway)) {
                        $("#no_data").show();
                        self.stopLoading();
                    } else {
                        var binCount = 0;
                        var bins = {};
                        for (var k in throwAway) {
                            binCount++;
                            var bin = throwAway[k];
                            if (bin in bins) {
                                bins[bin].push(k);
                            } else {
                                bins[bin] = [k];
                            }
                        }

                        var binDiv = $("#bins");
                        binDiv.empty();
                        var binCls = "col-sm-" + parseInt(12 / binCount);

                        var binId = 0;
                        for (var k in bins) {
                            binDiv.append('<div class="text-center"><h3>' + k + '</h3><div id="bin-' + parseInt(binId) + '"></div></div>');
                            var bin = $("#bin-" + parseInt(binId));
                            var materials = bins[k];
                            for (var i = 0; i < materials.length; i++) {
                                bin.append(materials[i] + "<br>");
                            }
                            binId++;
                        }
                        $("#throwaway").show();
                        self.stopLoading();
                    }
                }).fail(function(xhr) {
                    recycle.addClass("has-error");
                    $("#help").html(xhr.responseText.replace(/\n/g, "<br>"));
                    self.stopLoading();
                });
            }
            return false;
        }
    };

    App.init(JOB);

    var Suggester = {
        init: function(app) {
            this.attachListeners();
            this.app = app;
        },
        attachListeners: function() {
            var self = this;
            var suggest_form = $("#suggest_form");

            $("#suggest_modal").on("hidden.bs.modal", function () {
                suggest_form.removeClass("has-error");
            });

            suggest_form.submit(function (evt) {
                evt.preventDefault();

                var selected = [];
                $('#materials_list input:checked').each(function() {
                    var name = $(this).attr("id");
                    var id = name.replace("materialId-", "");
                    var text = $("label[for=" + name + "]");
                    selected.push({name: text.text(), id: parseInt(id)});
                });

                if (selected.length == 0) {
                    suggest_form.addClass("has-error");
                } else {
                     $.post("/package/add", {materials: JSON.stringify(selected), ean: self.app.product.ean}, function() {
                        self.app.submit(self.app.product.ean);
                        $('#suggest_modal').modal('toggle');
                    });
                }

                return false;
            });

            $(".suggest_button").click(function() {
                var url = "/materials/";

                $.get(url, function(data) {
                    data = $.parseJSON(data)

                    if (data.length == 0) {
                        $("#suggest_help").text("Pas d'emballage disponible");
                    } else {
                        var lst = $("#materials_list");
                        lst.html("");
                        for (var i = 0; i < data.length; i++) {
                            var v = data[i]
                            self.addMaterialItem(lst, v.id, v.name);
                        }

                        if (self.app.product != null) {
                            for (var i = 0; i < self.app.product.materials.length; i++) {
                                var id = self.app.product.materials[i].id;
                                $("#materialId-" + id.toString()).prop("checked", true);
                            }
                        }
                    }
                }).fail(function(xhr) {
                    $("#suggest_help").html(xhr.responseText.replace(/\n/g, "<br>"));
                });
            });
        },

        addMaterialItem: function(lst, id, name) {
            lst.append('<div class="checkbox col-sm-4 suggest-checkbox"><label for="materialId-' + id + '"><input type="checkbox" value="" id="materialId-' + id + '">' + name + '</label></div>');
        },

        detachListeners: function() {
            $("#suggest_modal").off("hidden.bs.modal");
            $("#suggest_form").off("submit");
            $(".suggest_button").off("click");
        },

    };

    Suggester.init(App);


    var BlackLister = {
        init: function(app) {
            this.attachListeners();
            this.app = app;
        },

        attachListeners: function() {
            var self = this;

            var blacklist = $("#blacklist_form");
            $("#blacklist_modal").on("hidden.bs.modal", function () {
                blacklist.removeClass("has-error");
            });

            blacklist.submit(function (evt) {
                evt.preventDefault();
                var name = $("#blacklist_name");
                var nameVal = name.val();

                if (nameVal.length == 0) {
                    blacklist.addClass("has-error");
                } else {
                    var product = self.app.product;
                    $.post("/blacklist/add", {name: nameVal, url: product.url, ean: product.ean, website: product.websiteName}, function() {
                        $('#blacklist_modal').modal('toggle');
                    });
                }

                return false;
            });
        },

        detachListeners: function() {
            $("#blacklist_modal").off("hidden.bs.modal");
            $("#blacklist_form").off("submit");
        },

    };

    BlackLister.init(App)
});



</script>
</body>
</html>