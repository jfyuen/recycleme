<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Comment me recycler ?</title>
    <script src="//code.jquery.com/jquery-2.2.1.min.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"
          integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <style>
        html {
            position: relative;
            min-height: 100%;
        }

        body {
            /* Margin bottom by footer height */
            margin-bottom: 60px;
        }

        .footer {
            position: absolute;
            bottom: 10px;
            width: 100%;
        }

        .form-control-inline {
            min-width: 0;
            width: auto;
            display: inline;
        }

        .bin {
            float: none;
        }

        #image {
            max-width: 300px;
        }

        #loading {
            opacity: 0;
        }

        .glyphicon.spinning {
            animation: spin 1.5s infinite linear;
            -webkit-animation: spin2 1.5s infinite linear;
        }

        @keyframes spin {
            from { transform: scale(1) rotate(0deg); }
            to { transform: scale(1) rotate(360deg); }
        }

        @-webkit-keyframes spin2 {
            from { -webkit-transform: rotate(0deg); }
            to { -webkit-transform: rotate(360deg); }
        }
    </style>
</head>
<body>
<section class="container-fluid text-center">
    <header class="page-header"><h1>Comment me recycler ?</h1>à Paris</header>
    <p>
        Vous ne savez pas dans quelle poubelle jeter les différents emballages d'un produit ?<br>
        Ne cherchez plus, rentrez le code barre ci-dessous !
    </p>
    <div class="row">
        <form role="form" class="form-inline" id="recycle_form">
            <label class="sr-only" for="barcode">Code barre</label>
            <input type="text" class="form-control form-control-inline" id="barcode" placeholder="Code barre" size="24" required>
            <button type="submit" class="btn btn-primary">
                Recycler
            </button>
            <span style="width:40px">&nbsp;
                <span class="glyphicon glyphicon-refresh spinning" id="loading"></span>
            </span>
            <span class="help-block" id="help"></span>
        </form>
    </div>
</section>

<section class="container-fluid collapse text-center" id="product">
    <h2 class="name"></h2>
    <img src="" id="image">
    <div class="source">Source: <a href="" id="source_url" target="_blank"></a></div>
    <button type="button" class="btn btn-info btn-default" data-toggle="modal" data-target="#blacklist_modal">Pas le bon produit ?</button>
</section>

<section class="container-fluid collapse text-center" id="no_data">
    <h3>Aucune information d'emballage trouvée</h3>
    <button type="button" class="btn btn-info btn-default" data-toggle="modal" data-target="#suggest_modal" id="suggest_button">Suggérer un emballage</button>
</section>

<section class="container-fluid collapse" id="throwaway">
    <div class="col-sm-4 text-center" id="green_bin">
        <h3 style="color:green">Bac à couvercle vert</h3>
        <div id="green_list"></div>
    </div>
    <div class="col-sm-4 text-center" id="yellow_bin">
        <h3 style="color:orange">Bac à couvercle jaune</h3>
        <div id="yellow_list"></div>
    </div>
    <div class="col-sm-4 text-center" id="white_bin">
        <h3>Bac à couvercle blanc</h3>
        <div id="white_list"></div>
    </div>
</section>

<!-- Blacklist Modal -->
<div class="modal fade" id="blacklist_modal" role="dialog">
    <div class="modal-dialog">

        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h2 class="modal-title">Signaler un mauvais produit</h2>
            </div>
            <div class="modal-body">
                <p>Le code barre <b class="ean"></b> ne correspond pas à <b class="name "></b> ?</p>
                <form role="form" class="form-inline" id="blacklist_form">
                    <label class="sr-only" for="blacklist_name">Nom du bon produit</label>
                    <input type="text" class="form-control form-control-inline" id="blacklist_name" placeholder="Nom du bon produit" size="50" required>
                    <button type="submit" class="btn btn-primary">
                        Signaler
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Suggest Modal -->
<div class="modal fade" id="suggest_modal" role="dialog">
    <div class="modal-dialog">

        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h2 class="modal-title">Suggérer un emballage</h2>
            </div>
            <div class="modal-body">
                <div id="suggest_help"></div>
                <form role="form" class="form-group" id="suggest_form">
                    <div id="materials_list">
                    </div>
                    <button type="submit" class="btn btn-primary">
                        Suggérer
                    </button>
                </form>
                <!--<form role="form" class="form-inline" id="missing_package_form">-->
                    <!--<label class="sr-only" for="missing_package_name">Nom d'un emballage</label>-->
                    <!--<input type="text" class="form-control form-control-inline" id="missing_package_name" placeholder="Nom d'un emballage" size="50" required>-->
                    <!--<button type="submit" class="btn btn-default">-->
                        <!--Ajouter-->
                    <!--</button>-->
                <!--</form>-->
            </div>
        </div>
    </div>
</div>

<footer class="footer">
    <div class="container text-center small">
        2016 // <a href="mailto:jfyuen@gmail.com">jfyuen</a> //
        <a href="https://github.com/jfyuen/recycleme" target="_blank">source</a>
    </div>
</footer>
<script>
        "use strict";
        var product;

        function isLoading() {
            return $("#loading").css("opacity") != 0;
        }

        function hideAll() {
            $("#no_data").hide();
            $("#product").hide();
            $(".name").empty();
            $(".ean").empty();
            $("#image").src = "";
            $("#throwaway").hide();
            $("#green_list").empty();
            $("#yellow_list").empty();
            $("#white_list").empty();
            $("#source_url").empty();
        }


        var recycle = $("#recycle_form");
        recycle.submit(function (evt) {
            evt.preventDefault();

            if (isLoading()) {
                return false;
            }

            hideAll();

            var barcode = $("#barcode");
            var barcodeVal = barcode.val();

            if (barcodeVal.length == 0) {
                recycle.addClass("has-error");
            } else {
                product = null;
                $("#loading").fadeTo("fast", 1.);
                recycle.removeClass("has-error");
                $("#help").text("");
                var url = "/throwaway/" + barcodeVal;

                $.get(url, function(data) {
                    data = $.parseJSON(data)
                    var throwAway = data.ThrowAway;
                    product = data.Product;
                    $(".name").text(product.Name);
                    $(".ean").text(product.EAN);
                    $("#image").attr("src", product.ImageURL);
                    var sourceUrl = $("#source_url");
                    sourceUrl.attr("href", product.WebsiteURL);
                    sourceUrl.text(product.WebsiteName);
                    $("#product").show();

                    if (jQuery.isEmptyObject(throwAway)) {
                        $("#no_data").show();
                        $("#loading").fadeTo("fast", 0.);
                    } else {
                        for (var k in throwAway) {
                            var bin;
                            switch (k) {
                                case "Bac à couvercle vert":
                                    bin = $("#green_list");
                                    break;
                                case "Bac à couvercle jaune":
                                    bin = $("#yellow_list");
                                    break;
                                case "Bac à couvercle blanc":
                                    bin = $("#white_list");
                                    break;
                            }
                            var materials = throwAway[k];
                            for (var i = 0; i < materials.length; i++) {
                                bin.append(materials[i].Name + "<br>");
                            }
                        }
                        $("#throwaway").show();
                        $("#loading").fadeTo("fast", 0.);
                    }
                }).fail(function(xhr) {
                    recycle.addClass("has-error");
                    $("#help").html(xhr.responseText.replace(/\n/g, "<br>"));
                    $("#loading").fadeTo("fast", 0.);
                });
            }
            return false;
        });


        var blacklist = $("#blacklist_form");
        blacklist.submit(function (evt) {
            evt.preventDefault();
            var name = $("#blacklist_name");
            var nameVal = name.val();

            if (nameVal.length == 0) {
                blacklist.addClass("has-error");
            } else {
                $.post("/blacklist/add", {name: nameVal, url: product.URL, ean: product.EAN, website: product.WebsiteName}, function() {
                    $('#blacklist_modal').modal('toggle');
                });
            }

            return false;
        });

        $("#blacklist_modal").on("hidden.bs.modal", function () {
            blacklist.removeClass("has-error");
        });

        function addMaterialItem(lst, id, name) {
            lst.append('<div class="checkbox-inline col-sm-4"><label for="materialId-' + id + '"><input type="checkbox" value="" id="materialId-' + id + '">' + name + '</label></div>');
        }

        $("#suggest_button").click(function() {
            var url = "/materials/";

            $.get(url, function(data) {
                data = $.parseJSON(data)
                console.log(data);

                if (jQuery.isEmptyObject(data)) {
                    $("#suggest_help").text("Pas d'emballage disponible");
                } else {
                    var lst = $("#materials_list");
                    lst.html("");
                    for (var k in data) {
                        addMaterialItem(lst, k, data[k].Name);
                    }
                }
            }).fail(function(xhr) {
                $("#suggest_help").html(xhr.responseText.replace(/\n/g, "<br>"));
            });
        });

        var suggest_form = $("#suggest_form");
        suggest_form.submit(function (evt) {
            evt.preventDefault();

            var selected = [];
            $('#materials_list input:checked').each(function() {
                var name = $(this).attr("id");
                var id = name.replace("materialId-", "");
                var text = $("label[for=" + name + "]");
                selected.push({name: text.text(), id: parseInt(id)});
            });

            if (selected.length == 0) {
                suggest_form.addClass("has-error");
            } else {
                console.log(selected);
                 $.post("/materials/add", {materials: JSON.stringify(selected), ean: product.EAN}, function() {
                    $('#suggest_modal').modal('toggle');
                });
            }

            return false;
        });

        $("#suggest_modal").on("hidden.bs.modal", function () {
            suggest_form.removeClass("has-error");
        });

</script>
</body>
</html>